---
layout: post
title: Kibana
tags: [Elasticsearch]
color: rgb(250, 154, 133)
feature-img: "assets/img/post-cover/25-cover.png"
thumbnail: "assets/img/post-cover/25-cover.png"
author: QubitPi
excerpt_separator: <!--more-->
---

<!--more-->

* TOC
{:toc}

## Install

### Mac

#### Latest Version

Elastic publishes Homebrew formulae so you can install Kibana with the [Homebrew](https://brew.sh/) package manager.

To install with Homebrew, you first need to tap the Elastic Homebrew repository:

```bash
brew tap elastic/tap
```

Once you've tapped the Elastic Homebrew repo, you can install the latest version of Kibana:

```bash
brew install elastic/tap/kibana-full
```

##### Directory layout for Homebrew Installs

When you install Kibana with Homebrew, the config files, logs, and data directory are stored in the following locations:

| Type        | Description                                                                                             | Default Location                                     | Setting     |
|-------------|---------------------------------------------------------------------------------------------------------|------------------------------------------------------|-------------|
| **home**    | Kibana home directory or `$KIBANA_HOME`                                                                 | `/usr/local/var/homebrew/linked/kibana-full`         |             |
| **bin**     | Binary scripts including `kibana` to start a node and `kibana-plugin` to install plugins                | `/usr/local/var/homebrew/linked/kibana-full/bin`     |             |
| **conf**    | Configuration files including `kibana.yml`                                                              | `/usr/local/etc/kibana`                              |             |
| **data**    | The location of the data files of each index / shard allocated on the node. Can hold multiple locations | `/usr/local/var/lib/kibana`                          | `path.data` |
| **logs**    | Log files location                                                                                      | `/usr/local/var/log/kibana`                          | `path.logs` |
| **plugins** | Plugin files location. Each plugin will be contained in a subdirectory                                  | `/usr/local/var/homebrew/linked/kibana-full/plugins` |             |

#### Other Versions

It is a requirement to [install specific version of Kibana](https://formulae.brew.sh/formula/kibana) that matches your
Elasticsearch version, otherwise Kibana won't start properly. We will take version 6 as an example in the following
discussions.

To install Kibana 6, execute

    brew install kibana@6

For more information, see https://formulae.brew.sh/formula/kibana

## Using Kibana

### Star Kibana

We need to tell Kibana where our Elasticsearch instance is so that it can connect to it when it starts. To do that,
specify the IP and port of the Elasticsearch instance in the Kibana config file, which should be
`/usr/local/etc/kibana/kibana.yml` on mac. Find a line that looks like `elasticsearch.hosts: [...]` and specify the
IP and port number of the Elasticsearch instance there, For example:
`elasticsearch.hosts: ["http://192.168.0.1:19200"]`. If the Elasticsearch instance requires authentication, locate
`elasticsearch.username` and `elasticsearch.password` and put then authentication info there accordingly.

Now we can start Kibana in the following way

    $ brew services start kibana@6
    ==> Successfully started `kibana@6` (label: homebrew.mxcl.kibana@6)

> Note: Updating config file requires a Kibana reboot, which is done via `brew services restart kibana@6`

When Kibana is up and running, we shall interact with Kibana UI at [http://localhost:5601](http://localhost:5601)

![Dashboard Screenshot]({{ "/assets/img/dashboard.png" | relative_url}})

### Browsing Data

#### Step 1 - Creating Index

Open up a browser and hit [http://localhost:5601](http://localhost:5601)

![Creating Index Example]({{ "/assets/img/creating-index.png" | relative_url}})

Hit "Next step" and click through to create an index

#### Step 2 - Browsing Data

Go to the "Discover" tab on the left side of Kibana UI and you should be able to see the data under the index we just
created:

![Browsing Data Example]({{ "/assets/img/browsing-data.png" | relative_url}})

### Index

#### Deleting Index

Kibana doesn't support deleting index, but we could use its
[REST API](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-delete-index.html) to do so

### Stop Kibana

`brew services stop kibana@6`

## Troubleshooting

### Kibana has started but UI is not Accessible

#### Problem

The command 

    brew services restart/start kibana@6
    
was successful, for excample, with the output of

    ==> Successfully started `kibana@6` (label: homebrew.mxcl.kibana@6)
    
But the UI is not responding: 

![Error loading kibana-ui-not-responding.png]({{ "/assets/img/kibana-ui-not-responding.png" | relative_url}})

#### Solution

Make sure kibana log is printing to terminal for potential investigations by identifying the following excerpt and
uncommenting the `logging.dest: stdout` in `/usr/local/etc/kibana/kibana.yml` as follows:

    # Enables you to specify a file where Kibana stores log output.
    logging.dest: stdout
    
Then start the Kibana through its native command:

    kibana serve
    
Errors should follow after the command above:

```bash
$ kibana serve
  log   [03:24:34.396] [fatal][root] { ValidationError: child "elasticsearch" fails because [child "hosts" fails because ["hosts" at position 0 fails because ["0" must be a valid uri with a scheme matching the http|https pattern]]]
    at Object.exports.process (/usr/local/Cellar/kibana@6/6.8.12/node_modules/joi/lib/errors.js:196:19)
    at internals.Object._validateWithOptions (/usr/local/Cellar/kibana@6/6.8.12/node_modules/joi/lib/types/any/index.js:675:31)
    at module.exports.internals.Any.root.validate (/usr/local/Cellar/kibana@6/6.8.12/node_modules/joi/lib/index.js:146:23)
    at Config._commit (/usr/local/Cellar/kibana@6/6.8.12/src/server/config/config.js:143:35)
    at Config.set (/usr/local/Cellar/kibana@6/6.8.12/src/server/config/config.js:111:10)
    at Config.extendSchema (/usr/local/Cellar/kibana@6/6.8.12/src/server/config/config.js:84:10)
    at extendConfigService (/usr/local/Cellar/kibana@6/6.8.12/src/plugin_discovery/plugin_config/extend_config_service.js:45:10) name: 'ValidationError' }

 FATAL  ValidationError: child "elasticsearch" fails because [child "hosts" fails because ["hosts" at position 0 fails because ["0" must be a valid uri with a scheme matching the http|https pattern]]]
```

The last line makes it clear that the Kibana failed to start because the Elasticsearch host URL was mis-configured. The
URL needs to be prefixed with `http/https`. **Open `/usr/local/etc/kibana/kibana.yml` and identify the
`elasticsearch.hosts` config key. A correct URL should look somethings like the follwoing:

    elasticsearch.hosts: ["http://192.168.0.1:19200"]
